<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.cachalot.intelligentattendancesystem.mapper.AttendMapper">
    <insert id="creatUserAttend">
        insert into user_attend (day, attend_id, user_id) VALUES
        <foreach collection="mapList" item="map" index="index" separator=",">
            (#{date},#{map.attendId},#{map.userId})
        </foreach>
    </insert>
    <insert id="creatAttend">
        insert into attend (attend_id) VALUES
        <foreach collection="attendIds" item="attendId" separator=",">
            (#{attendId})
        </foreach>
    </insert>
    <update id="checkFirstSign">
        update user_attend
        <set>
            <if test="status == 6">
                `status` = 5,
            </if>
        </set>
        where `day` =#{date}
    </update>
    <update id="checkSecondSign">
        update user_attend
        <set>
            <if test="status == 5">
                `status` = 4,
            </if>
        </set>
        where `day` =#{date} and `attend_id` in (select `attend_id` from attend where second_time = null )
    </update>
    <update id="checkThirdSign">
        update user_attend
        <set>
            <if test="status == 1">
                `status` = 5,
            </if>
        </set>
        where `day` =#{date} and `attend_id` in (select `attend_id` from attend where third_time = null )
    </update>
    <update id="checkFourthSign">
        update user_attend
        <set>
            <if test="status == 5">
                `status` = 4,
            </if>
        </set>
        where `day` =#{date}
        and `attend_id` in (select `attend_id` from attend where fourth_time = null )
        and `attend_id` in (select `attend_id` from attend where third_time = null )
    </update>

    <select id="getAttendByUserId" resultType="cn.cachalot.intelligentattendancesystem.dto.attendDto.GetAttendRes">
        select *
        from (select *
              from `user_attend`
              where `user_id` = #{userId}
              order by day desc
              limit ${days}) as t
    </select>
    <select id="getAllAttendByDate" resultType="cn.cachalot.intelligentattendancesystem.dto.attendDto.GetAttendRes">
        select *
        from `user_attend`
        where `day` = #{date}
    </select>
    <select id="getAttendByDateAndDepartment" resultType="cn.cachalot.intelligentattendancesystem.dto.attendDto.GetAttendRes">
        select *
        from `user_attend`
        where `day` = #{date}
          and `user_id` in (select `user_id` from `user` where `department` = #{department})
    </select>
    <select id="getOneAttendByDateAndUserId"
            resultType="cn.cachalot.intelligentattendancesystem.dto.attendDto.GetAttendRes">
        select *
        from `user_attend`
        where `day` = #{date}
          and `user_id` = #{id}
    </select>
    <select id="getAttendDetail" resultType="cn.cachalot.intelligentattendancesystem.entity.Attend">
        select *
        from `attend`
        where `attend_id` = #{attendId}
    </select>
    <select id="getUserIdByAttendId" resultType="java.lang.Long">
        select `user_id`
        from user_attend
        where attend_id = #{attendId}
    </select>
</mapper>